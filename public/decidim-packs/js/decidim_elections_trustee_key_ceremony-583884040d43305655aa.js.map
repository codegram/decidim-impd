{"version":3,"file":"js/decidim_elections_trustee_key_ceremony-583884040d43305655aa.js","sources":["webpack://decidim/./node_modules/@babel/runtime/regenerator/index.js","webpack://decidim/../../.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/bundler/gems/decidim-d3b88afe90e5/decidim-elections/app/packs/src/decidim/elections/trustee/key_ceremony.js","webpack://decidim/ignored|/Users/oriol/Code/decidim-impd-new/node_modules/node-forge/lib|crypto","webpack://decidim/ignored|/Users/oriol/Code/decidim-impd-new/node_modules/node-jose/lib/algorithms|crypto","webpack://decidim/webpack/bootstrap","webpack://decidim/webpack/runtime/chunk loaded","webpack://decidim/webpack/runtime/compat get default export","webpack://decidim/webpack/runtime/define property getters","webpack://decidim/webpack/runtime/global","webpack://decidim/webpack/runtime/harmony module decorator","webpack://decidim/webpack/runtime/hasOwnProperty shorthand","webpack://decidim/webpack/runtime/make namespace object","webpack://decidim/webpack/runtime/node module decorator","webpack://decidim/webpack/runtime/jsonp chunk loading","webpack://decidim/webpack/startup"],"sourcesContent":["module.exports = require(\"regenerator-runtime\");\n","import {\n  KeyCeremonyComponent,\n  MessageIdentifier,\n  IdentificationKeys,\n  MESSAGE_RECEIVED\n} from \"@codegram/decidim-bulletin_board\";\n\nimport { TrusteeWrapperAdapter as DummyTrusteeWrapperAdapter } from \"@codegram/voting_schemes-dummy\";\nimport { TrusteeWrapperAdapter as ElectionGuardTrusteeWrapperAdapter } from \"@codegram/voting_schemes-electionguard\";\n\n/**\n * This file is responsible to generate election keys,\n * create a backup of keys for the trustee and\n * update the election bulletin board status\n */\n$(() => {\n  // UI Elements\n  const $keyCeremony = $(\".trustee-step\");\n  const $startButton = $keyCeremony.find(\".start\");\n  const $backupModal = $(\"#show-backup-modal\");\n  const $backupButton = $backupModal.find(\".download-election-keys\");\n  const $backButton = $keyCeremony.find(\".back\");\n  const $restoreModal = $(\"#show-restore-modal\");\n  const $restoreButton = $restoreModal.find(\".upload-election-keys\");\n  const getStepRow = (step) => {\n    return $(`#${step.replace(\".\", \"-\")}`);\n  };\n  const TRUSTEE_AUTHORIZATION_EXPIRATION_TIME_IN_HOURS = 2;\n\n  // Data\n  const bulletinBoardClientParams = {\n    apiEndpointUrl: $keyCeremony.data(\"apiEndpointUrl\")\n  };\n  const electionUniqueId = `${$keyCeremony.data(\n    \"authoritySlug\"\n  )}.${$keyCeremony.data(\"electionId\")}`;\n  const authorityPublicKeyJSON = JSON.stringify(\n    $keyCeremony.data(\"authorityPublicKey\")\n  );\n  const schemeName = $keyCeremony.data(\"schemeName\");\n\n  const trusteeContext = {\n    uniqueId: $keyCeremony.data(\"trusteeSlug\"),\n    publicKeyJSON: JSON.stringify($keyCeremony.data(\"trusteePublicKey\"))\n  };\n\n  let currentStep = null;\n  const trusteeIdentificationKeys = new IdentificationKeys(\n    trusteeContext.uniqueId,\n    trusteeContext.publicKeyJSON\n  );\n\n  // Use the correct trustee wrapper adapter\n  let trusteeWrapperAdapter = null;\n\n  if (schemeName === \"dummy\") {\n    trusteeWrapperAdapter = new DummyTrusteeWrapperAdapter({\n      trusteeId: trusteeContext.uniqueId\n    });\n  } else if (schemeName === \"electionguard\") {\n    trusteeWrapperAdapter = new ElectionGuardTrusteeWrapperAdapter({\n      trusteeId: trusteeContext.uniqueId,\n      workerUrl: \"/assets/electionguard/webworker.js\"\n    });\n  } else {\n    throw new Error(`Voting scheme ${schemeName} not supported.`);\n  }\n\n  // Use the key ceremony component and bind all UI events\n  const component = new KeyCeremonyComponent({\n    authorityPublicKeyJSON,\n    trusteeUniqueId: trusteeContext.uniqueId,\n    trusteeIdentificationKeys,\n    trusteeWrapperAdapter\n  });\n\n  trusteeIdentificationKeys.present(async (exists) => {\n    if (exists) {\n      await component.setupElection({\n        bulletinBoardClientParams,\n        electionUniqueId,\n        authorizationExpirationTimestamp:\n          Math.ceil(Number(new Date()) / 1000) +\n          TRUSTEE_AUTHORIZATION_EXPIRATION_TIME_IN_HOURS * 3600\n      });\n\n      await component.bindEvents({\n        onBindRestoreButton(onEventTriggered) {\n          $restoreButton.on(\n            \"change\",\n            \".restore-button-input\",\n            onEventTriggered\n          );\n        },\n        onBindStartButton(onEventTriggered) {\n          $startButton.on(\"click\", onEventTriggered);\n        },\n        onBindBackupButton(backupData, backupFilename, onEventTriggered) {\n          $backupButton.attr(\n            \"href\",\n            `data:text/plain;charset=utf-8,${backupData}`\n          );\n          $backupButton.attr(\"download\", backupFilename);\n          $backupButton.on(\"click\", onEventTriggered);\n        },\n        onEvent(event) {\n          let messageIdentifier = MessageIdentifier.parse(\n            event.message.messageId\n          );\n\n          if (event.type === MESSAGE_RECEIVED) {\n            if (currentStep && currentStep !== messageIdentifier.typeSubtype) {\n              const $previousStep = getStepRow(currentStep);\n              $previousStep.attr(\"data-step-status\", \"completed\");\n            }\n            currentStep = messageIdentifier.typeSubtype;\n\n            const $currentStep = getStepRow(currentStep);\n            if ($currentStep.data(\"step-status\") !== \"completed\") {\n              $currentStep.attr(\"data-step-status\", \"processing\");\n            }\n          }\n        },\n        onRestore() {\n          $restoreModal.foundation(\"close\");\n        },\n        onComplete() {\n          const $allSteps = $(\".step_status\");\n          $allSteps.attr(\"data-step-status\", \"completed\");\n\n          $startButton.addClass(\"hide\");\n          $backButton.removeClass(\"hide\");\n\n          $.ajax({\n            method: \"PATCH\",\n            url: $keyCeremony.data(\"updateElectionStatusUrl\"),\n            contentType: \"application/json\",\n            data: JSON.stringify({\n              status: \"key_ceremony\"\n            }),\n            headers: {\n              \"X-CSRF-Token\": $(\"meta[name=csrf-token]\").attr(\"content\")\n            }\n          });\n        },\n        onStart() {\n          $startButton.prop(\"disabled\", true);\n        },\n        onTrusteeNeedsToBeRestored() {\n          $restoreModal.foundation(\"open\");\n        },\n        onBackupNeeded() {\n          $backupModal.foundation(\"open\");\n        },\n        onBackupStarted() {\n          $backupModal.foundation(\"close\");\n        }\n      });\n\n      $startButton.prop(\"disabled\", false);\n    }\n  });\n});\n","/* (ignored) */","/* (ignored) */","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\tid: moduleId,\n\t\tloaded: false,\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Flag the module as loaded\n\tmodule.loaded = true;\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","var deferred = [];\n__webpack_require__.O = function(result, chunkIds, fn, priority) {\n\tif(chunkIds) {\n\t\tpriority = priority || 0;\n\t\tfor(var i = deferred.length; i > 0 && deferred[i - 1][2] > priority; i--) deferred[i] = deferred[i - 1];\n\t\tdeferred[i] = [chunkIds, fn, priority];\n\t\treturn;\n\t}\n\tvar notFulfilled = Infinity;\n\tfor (var i = 0; i < deferred.length; i++) {\n\t\tvar chunkIds = deferred[i][0];\n\t\tvar fn = deferred[i][1];\n\t\tvar priority = deferred[i][2];\n\t\tvar fulfilled = true;\n\t\tfor (var j = 0; j < chunkIds.length; j++) {\n\t\t\tif ((priority & 1 === 0 || notFulfilled >= priority) && Object.keys(__webpack_require__.O).every(function(key) { return __webpack_require__.O[key](chunkIds[j]); })) {\n\t\t\t\tchunkIds.splice(j--, 1);\n\t\t\t} else {\n\t\t\t\tfulfilled = false;\n\t\t\t\tif(priority < notFulfilled) notFulfilled = priority;\n\t\t\t}\n\t\t}\n\t\tif(fulfilled) {\n\t\t\tdeferred.splice(i--, 1)\n\t\t\tresult = fn();\n\t\t}\n\t}\n\treturn result;\n};","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = function(module) {\n\tvar getter = module && module.__esModule ?\n\t\tfunction() { return module['default']; } :\n\t\tfunction() { return module; };\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = function(exports, definition) {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.hmd = function(module) {\n\tmodule = Object.create(module);\n\tif (!module.children) module.children = [];\n\tObject.defineProperty(module, 'exports', {\n\t\tenumerable: true,\n\t\tset: function() {\n\t\t\tthrow new Error('ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: ' + module.id);\n\t\t}\n\t});\n\treturn module;\n};","__webpack_require__.o = function(obj, prop) { return Object.prototype.hasOwnProperty.call(obj, prop); }","// define __esModule on exports\n__webpack_require__.r = function(exports) {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","__webpack_require__.nmd = function(module) {\n\tmodule.paths = [];\n\tif (!module.children) module.children = [];\n\treturn module;\n};","// no baseURI\n\n// object to store loaded and loading chunks\n// undefined = chunk not loaded, null = chunk preloaded/prefetched\n// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded\nvar installedChunks = {\n\t\"decidim_elections_trustee_key_ceremony\": 0\n};\n\n// no chunk on demand loading\n\n// no prefetching\n\n// no preloaded\n\n// no HMR\n\n// no HMR manifest\n\n__webpack_require__.O.j = function(chunkId) { return installedChunks[chunkId] === 0; };\n\n// install a JSONP callback for chunk loading\nvar webpackJsonpCallback = function(parentChunkLoadingFunction, data) {\n\tvar chunkIds = data[0];\n\tvar moreModules = data[1];\n\tvar runtime = data[2];\n\t// add \"moreModules\" to the modules object,\n\t// then flag all \"chunkIds\" as loaded and fire callback\n\tvar moduleId, chunkId, i = 0;\n\tfor(moduleId in moreModules) {\n\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t}\n\t}\n\tif(runtime) var result = runtime(__webpack_require__);\n\tif(parentChunkLoadingFunction) parentChunkLoadingFunction(data);\n\tfor(;i < chunkIds.length; i++) {\n\t\tchunkId = chunkIds[i];\n\t\tif(__webpack_require__.o(installedChunks, chunkId) && installedChunks[chunkId]) {\n\t\t\tinstalledChunks[chunkId][0]();\n\t\t}\n\t\tinstalledChunks[chunkIds[i]] = 0;\n\t}\n\treturn __webpack_require__.O(result);\n}\n\nvar chunkLoadingGlobal = self[\"webpackChunkdecidim\"] = self[\"webpackChunkdecidim\"] || [];\nchunkLoadingGlobal.forEach(webpackJsonpCallback.bind(null, 0));\nchunkLoadingGlobal.push = webpackJsonpCallback.bind(null, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));","// startup\n// Load entry module and return exports\n// This entry module depends on other loaded chunks and execution need to be delayed\nvar __webpack_exports__ = __webpack_require__.O(undefined, [\"vendors-node_modules_regenerator-runtime_runtime_js\",\"vendors-node_modules_codegram_decidim-bulletin_board_src_index_js\",\"vendors-node_modules_codegram_voting_schemes-dummy_src_index_js-node_modules_codegram_voting_-13cf33\"], function() { return __webpack_require__(\"../../.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/bundler/gems/decidim-d3b88afe90e5/decidim-elections/app/packs/entrypoints/decidim_elections_trustee_key_ceremony.js\"); })\n__webpack_exports__ = __webpack_require__.O(__webpack_exports__);\n"],"mappings":";;;;;;;;;AAAA;AACA;AACA;A;;;;;;;;;;;;;A;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AAOA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AADA;AACA;AAEA;AACA;AAEA;AACA;AADA;AAGA;AAGA;AAGA;AAEA;AACA;AACA;AAFA;AAKA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AADA;AADA;AAKA;AACA;AACA;AAFA;AADA;AAMA;AAlDA;AACA;AACA;AAoDA;AACA;AACA;AACA;AACA;AAJA;AAOA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAGA;AACA;AACA;AAHA;AACA;AAHA;AAAA;AAAA;AAWA;AACA;AAFA;AAQA;AACA;AATA;AAWA;AACA;AAIA;AACA;AAjBA;AAmBA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AAAA;AACA;AACA;AACA;AAnCA;AAqCA;AACA;AAtCA;AAwCA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AADA;AAPA;AA/CA;AA2DA;AACA;AA5DA;AA8DA;AACA;AA/DA;AAiEA;AACA;AAlEA;AAoEA;AACA;AACA;AAtEA;AACA;AAXA;AAmFA;AACA;AApFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AA7DA;AACA;A;;;;;;;;AChBA;AACA;A;;;;;;;;ACDA;AACA;A;;;;ACDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC7BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;AC5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;ACPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;ACPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;ACPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;ACVA;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;ACNA;AACA;AACA;AACA;AACA;;;;;ACJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;AChDA;AACA;AACA;AACA;AACA;;;A","sourceRoot":""}